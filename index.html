<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>現在地中心の無料地図（Leaflet + OSM）</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    /* ページ全体 */
    html, body, #map {
      margin: 0; padding: 0; height: 100%;
    }
    /* 地図コンテナ */
    #map {
      z-index: 1; /* コントロールより下にする */
    }
    /* ステータス表示 */
    .status {
      position: absolute; top: 8px; left: 8px;
      background: rgba(0,0,0,.65); color: #fff; padding: 6px 8px; border-radius: 4px;
      font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP", Meiryo, sans-serif;
      z-index: 1000;
      max-width: min(92vw, 480px);
    }
    /* コントロールボタン群 */
    .controls {
      position: absolute; top: 8px; right: 8px; z-index: 1000;
      display: flex; gap: 6px; flex-wrap: wrap;
    }
    .controls button {
      background: #0b57d0; color: #fff; border: 0; border-radius: 4px; padding: 6px 10px; cursor: pointer;
    }
    .controls button.secondary { background: #555; }
  </style>
</head>
<body>
  <div class="status" id="status">位置情報の取得を待機中…（初回はブラウザの許可が必要です）</div>
  <div class="controls">
    <button id="locateBtn">現在地へ</button>
    <button id="followBtn" class="secondary">移動に追従（ON/OFF）</button>
  </div>
  <div id="map" role="region" aria-label="地図"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <script>
    // --- 固定地点のデータ（松山市内の適当な5地点） ---
    const LOCATIONS_TO_ADD = [
      { name: 'A: 松山城', lat: 33.8416, lng: 132.7663 },
      { name: 'B: 道後温泉本館', lat: 33.8471, lng: 132.7936 },
      { name: 'C: JR松山駅', lat: 33.8398, lng: 132.7548 },
      { name: 'D: 松山空港', lat: 33.8341, lng: 132.6974 },
      { name: 'E: 松山中央公園', lat: 33.8118, lng: 132.7656 }
    ];

    // --- 初期化（フォールバック中心：松山駅あたり） ---
    const FALLBACK = { lat: 33.839, lng: 132.754, zoom: 14 }; 
    const statusEl = document.getElementById('status');
    const followBtn = document.getElementById('followBtn');

    // 地図生成
    const map = L.map('map', { zoomControl: true }).setView([FALLBACK.lat, FALLBACK.lng], FALLBACK.zoom);

    // OSMタイル（帰属表示は必須）
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 現在地マーカーと精度円
    let meMarker = null, accuracyCircle = null;
    let watchId = null, followOn = false;

    /**
     * 現在地マーカーと精度円を更新し、必要に応じて地図を中央に移動
     * @param {number} lat - 緯度
     * @param {number} lng - 経度
     * @param {number} accuracy - 精度 (m)
     * @param {boolean} center - trueの場合、地図を中央に移動
     */
    function updateMyLocation(lat, lng, accuracy, center = true) {
      const latlng = [lat, lng];
      if (!meMarker) {
        meMarker = L.marker(latlng, { title: '現在地' }).addTo(map);
      } else {
        meMarker.setLatLng(latlng);
      }
      if (!accuracyCircle) {
        accuracyCircle = L.circle(latlng, { radius: accuracy, color: '#136aec', weight: 2, fillColor: '#136aec', fillOpacity: 0.15 }).addTo(map);
      } else {
        accuracyCircle.setLatLng(latlng).setRadius(accuracy);
      }
      if (center) map.setView(latlng, Math.max(map.getZoom(), 16), { animate: true });
    }

    // 1回取得
    function locateOnce() {
      if (!('geolocation' in navigator)) {
        statusEl.textContent = 'このブラウザはGeolocation APIに対応していません。手動で移動してください。';
        return;
      }
      statusEl.textContent = '現在地を取得中…';
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          updateMyLocation(latitude, longitude, accuracy, true);
          statusEl.textContent = `現在地を表示しました（±約${Math.round(accuracy)}m）`;
        },
        (err) => {
          statusEl.textContent = `現在地の取得に失敗しました：${err.message}（権限・GPS・HTTPSをご確認ください）`;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // 連続追従のON/OFF
    function toggleFollow() {
      if (!('geolocation' in navigator)) {
        statusEl.textContent = 'このブラウザはGeolocation APIに対応していません。';
        return;
      }
      if (watchId !== null) {
        // 追従を停止
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        followOn = false;
        followBtn.textContent = '移動に追従（OFF）';
        followBtn.classList.add('secondary');
        statusEl.textContent = '追従を停止しました。';
        return;
      }
      
      // 追従を開始
      statusEl.textContent = '現在地を追跡中…';
      followOn = true;
      followBtn.textContent = '移動に追従（ON）';
      followBtn.classList.remove('secondary');

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          updateMyLocation(latitude, longitude, accuracy, followOn); 
          statusEl.textContent = `現在地を追跡中（±約${Math.round(accuracy)}m）`;
        },
        (err) => {
          statusEl.textContent = `追跡に失敗しました：${err.message}`;
          toggleFollow(); // 失敗したら停止
        },
        { enableHighAccuracy: true, maximumAge: 0 }
      );
    }

    // --- イベントリスナー ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('locateBtn').addEventListener('click', locateOnce);
      followBtn.addEventListener('click', toggleFollow);
      
      // 5つの固定地点を地図に追加
      LOCATIONS_TO_ADD.forEach(location => {
        const marker = L.marker([location.lat, location.lng], { title: location.name }).addTo(map);
        // ポップアップを設定
        marker.bindPopup(`<b>${location.name}</b><br>固定地点`); 
      });

      // 初回は現在地取得を実行
      locateOnce();
    });
  </script>
</body>
</html>